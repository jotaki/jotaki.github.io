<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="author" content="Joseph Kinsella" />
    <title>Pool Diagram Thingy</title>

    <script src="js/jquery-1.9.1.js"></script>
    <script src="js/jcanvas.min.js"></script>
    <script>
      /*
       * yanked from
       * http://stackoverflow.com/questions/3788125/jquery-querystring
       */

      function querystring(key) {
        var re=new RegExp('(?:\\?|&)'+key+'=(.*?)(?=&|$)','gi');
        var r=[], m;
        while ((m=re.exec(document.location.search)) != null) r.push(m[1]);
        return r;
      }

      function createLine(l, line_n, color) {
        $('#table').drawLine({
          layer: true,
          name: 'l' + line_n,
          strokeStyle: color,
          strokeWidth: 5,
          x1: l.startX, y1: l.startY,
          x2: l.eventX, y2: l.eventY,

          dblclick: function(l) {
            $('#table').removeLayer(l.name);
          }
        });
      }

      var lineIndex = 0;
      var isDrawing = 0;

      $(function() {
        $('#table').draw({
          layer: true,
          type: 'rectangle',
          fillStyle: '#ccc',
          width: 1000, height: 1000,
          fromCenter: false,
        });

        $('#table').drawImage({
          layer: true,
          name: 'table',
          source: 'images/table.png',
          fromCenter: false,

          mousedown: function(l) {
            isDrawing = 1;
            l.startX = l.eventX;
            l.startY = l.eventY;
          },

          mousemove: function(l) {
            if(isDrawing > 0) { 
              createLine(l, lineIndex, '#0cc');
            }
          },

          mouseup: function(l) {
            isDrawing = 0;
            $('#table').removeLayer('l' + lineIndex);
            createLine(l, lineIndex, '#00c');
            lineIndex++;
          }
        });

        var re = new RegExp('(\\d+)x(\\d+)');
        for(var i = 0; i <= 15; i++) {
          var yval = 525, xval = (i + 1) * 15 + ((i + 0.5) * 40);
          var m, ball = querystring('b' + i);

          if(ball && ball != '') {
            if((m = re.exec(ball)) != null) {
              yval = m[1], xval = m[2];
            }
          }

          $('#table').drawImage({
            layer: true,
            name: 'b' + i,
            source: 'images/' + i + '.png',
            x: xval, y: yval,
            draggable: true,
          });
        }

        re = new RegExp('(\\d+)t(\\d+)x(\\d+)t(\\d+)');
        for(var i = 0; querystring('l' + i) != ''; i++) {
          var m, line = querystring('l' + i);
          var info = {};

          if((m = re.exec(line)) != null) {
            info = {
              startX: parseInt(m[1]),
              startY: parseInt(m[2]),
              eventX: parseInt(m[3]),
              eventY: parseInt(m[4]),
            };
            lineIndex = i + 1;
            createLine(info, i, '#00c');
          }
        }
      });

      function copyLink() {
        var params = [];
        var baseurl = document.location.origin + document.location.pathname;
        for(var i = 0; i <= 15; i++) {
          var ball = $('#table').getLayer('b' + i);
          if(ball.y != 525) {
            params.push("b" + i + "=" + ball.y + "x" + ball.x);
          }
        }

        var i = 0, line;
        while((line = $('#table').getLayer("l" + i)) != null) {
          var x1 = line.x1, x2 = line.x2, y1 = line.y1, y2 = line.y2;

          params.push("l" + i + "=" + x1 + "t" + y1 + "x" + x2 + "t" + y2);

          i += 1;
        }

        if(params.length > 0) {
          $('#link').val(baseurl + '?' + params.join('&'));
        }
      }

      function saveImage() {
        var img = $('#table').getCanvasImage('png').replace('image/png', 'image/octet-stream');
        window.location.href = img;
      }
    </script>
  </head>
  <body>
    <canvas id="table" width="912" height="550"></canvas>
    <div id="links">
      <form>
        <a href="javascript:copyLink()">Generate Link</a>
        <input type="text" size="75" name="link" id="link" />
        <a href="javascript:saveImage()">Save Image</a>
      </form>
    </div>
    <div id="info">
      <p>
        This is a simple diagram thing for sharing pool situations. <br />
        It's hacked together using HTML5 with jquery and jcanvas. The<br />
        pool table image was taken from <a
          href="http://www.cheetah3d.com/forum/attachment.php?attachmentid=5304&amp;stc=1&amp;d=1217452437">here</a>.
        (Thanks Chris for sharing the link.)<br />
        <br />
        The pool balls themselves were done by me in gimp in about 15<br />
        minutes or so. You may use them if you'd like.<br />
      </p>
    </div>
  </body>
</html>
